---
title: "Кампусы России"
author: "Исследование Ксении Гайдай"
format: dashboard
html:
  theme: cosmo
  toc: false
  page-layout: full
---

# ДВФУ

## Row
### Column {width=60%}
#### {.tabset}
```{r, out.width = '100%'}
#| echo: false
#| message: false
#| warning: false
#| title: "План кампуса"
#| padding: 0px
# Загружаем библиотеки
library(leaflet)
library(sf)
library(dplyr)
library(htmltools)
library(colorRamps)
library(RColorBrewer)

# Загружаем данные
buildings <- st_read("Buildings_poly.geojson", quiet = TRUE)
campus <- st_read("education_poly.geojson", quiet = TRUE)

# Переводим типы зданий на русский и убираем NA значения
buildings <- buildings %>%
  mutate(
    b_type_rus = recode(
      b_type,
      "academ" = "Академическое",
      "cultural" = "Культурное",
      "dormit" = "Общежитие",
      "indust" = "Индустриальное",
      "lab" = "Лабораторное",
      "parking" = "Парковка",
      "pit" = "Столовая",
      "sport" = "Спортивное",
      "tech" = "Техническое",
      .default = b_type
    )
  ) %>%
  filter(!is.na(b_type_rus) & b_type_rus != "null")  # Убираем null и NA значения

# Центр карты
center <- c(lat = 43.028842, lng = 131.893193)

# Палитра для типов зданий
b_types <- unique(buildings$b_type_rus)
n <- length(b_types)
colors <- brewer.pal(max(n, 3), "Set2") # минимум 3 цвета
palette <- colorFactor(colors, domain = b_types)

# Создаём базовую карту
map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "Стандартная основа") %>%
  addProviderTiles("Esri.WorldImagery", group = "Спутниковая основа", options = providerTileOptions(opacity = 0.5)) %>%
  setView(lng = center["lng"], lat = center["lat"], zoom = 15) %>%
  
  # Слой с границей кампуса
  addPolygons(
    data = campus,
    color = "blue",
    weight = 2,
    group = "Граница кампуса"
  ) %>%
  
  # Кнопка сброса масштаба
  addEasyButton(easyButton(
    icon = "fa-globe",
    title = "Сбросить масштаб",
    onClick = JS(
      paste0("function(btn, map){ map.setView([", center["lat"], ", ", center["lng"], "], 15); }")
    )
  ))

# Добавляем отдельный слой для каждого типа здания
for(type in b_types){
  map <- map %>%
    addPolygons(
      data = buildings %>% filter(b_type_rus == type),
      color = "black",
      weight = 1,
      fillColor = ~palette(b_type_rus),
      fillOpacity = 0.7,
      popup = ~paste("<b>Тип здания:</b>", b_type_rus),
      group = type
    )
}

# Легенда
map <- map %>%
  addLegend(
    "topright",
    pal = palette,
    values = buildings$b_type_rus,
    title = "Типы зданий",
    opacity = 0.7
  ) %>%
  
  # Объединенный контрол в левом нижнем углу
  addLayersControl(
    baseGroups = c("Стандартная основа", "Спутниковая основа"),
    overlayGroups = c(b_types, "Граница кампуса"),
    options = layersControlOptions(collapsed = FALSE, position = "bottomleft")
  )

map
```

```{r, out.width = '100%'}
#| echo: false
#| message: false
#| warning: false
#| title: "Функциональные зоны"
#| padding: 0px
# Загружаем библиотеки
library(leaflet)
library(sf)
library(dplyr)
library(htmltools)
library(colorRamps)
library(RColorBrewer)

# Загружаем данные функциональных зон
func_zones <- st_read("func_zones.geojson", quiet = TRUE)
roads <- st_read("transs.geojson", quiet = TRUE)

# Центр карты
center <- c(lat = 43.028842, lng = 131.893193)

# Переводим типы зон на русский язык
func_zones <- func_zones %>%
  filter(!is.na(FZ) & FZ != "null" & FZ != "") %>%
  mutate(
    FZ_rus = recode(
      FZ,
      "academ"   = "Научно-образовательная",
      "cultural" = "Культурно-образовательная",
      "dormit"   = "Жилая",
      "green"    = "Ландшафтно-рекреационная",
      "indust"   = "Зона строительства",
      "parking"  = "Парковочная",
      "sport"    = "Спортивная",
      "tech"     = "Коммунального хозяйства",
      "uslugi"   = "Зона услуг"
    )
  )

# Жёстко заданные цвета по типам FZ
color_map <- c(
  "academ"   = "#f23761",
  "cultural" = "#f952e2",
  "dormit"   = "#ff807a",
  "green"    = "#abeca3",
  "indust"   = "#6863db",
  "parking"  = "#a82072",
  "sport"    = "#ffa860",
  "tech"     = "#8daf93",
  "uslugi"   = "#fff3a3"
)

# Палитра по исходным кодам FZ
palette <- colorFactor(color_map, domain = names(color_map))

# Создаём базовую карту
map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "Стандартная основа") %>%
  addProviderTiles("Esri.WorldImagery", group = "Спутниковая основа",
                   options = providerTileOptions(opacity = 0.5)) %>%
  setView(lng = center["lng"], lat = center["lat"], zoom = 15) %>%
  
  # Кнопка сброса масштаба
  addEasyButton(easyButton(
    icon = "fa-globe",
    title = "Сбросить масштаб",
    onClick = JS(
      paste0("function(btn, map){ map.setView([", center["lat"], ", ", center["lng"], "], 15); }")
    )
  ))

# Добавляем полигоны одним вызовом, с динамической раскраской по палитре
map <- map %>%
  addPolygons(
    data = func_zones,
    color = "black",
    weight = 1,
    fillColor = ~palette(FZ),
    fillOpacity = 0.7,
    popup = ~paste("<b>Функциональная зона:</b>", FZ_rus),
    group = ~FZ_rus
  )

# Добавляем легенду и контролы
map <- map %>%
  addLegend(
    "topright",
    colors = unname(color_map),
    labels = c(
      "Научно-образовательная",
      "Культурно-образовательная",
      "Жилая",
      "Ландшафтно-рекреационная",
      "Зона строительства",
      "Парковочная",
      "Спортивная",
      "Коммунального хозяйства",
      "Зона услуг"
    ),
    title = "Функциональные зоны",
    opacity = 0.9
  ) %>%
  addLayersControl(
    baseGroups = c("Стандартная основа", "Спутниковая основа"),
    overlayGroups = unique(func_zones$FZ_rus),
    options = layersControlOptions(collapsed = FALSE, position = "bottomleft")
  )
map
```

### Column{width=40%} 
#### {.tabset}
```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Функциональные зоны (%)"
#| padding: 0px
# Установка и загрузка пакетов
library(highcharter)
library(dplyr)

# Данные
data <- data.frame(
  FZ = c("academ", "cultural", "dormit", "green", "indust", 
         "parking", "sport", "tech", "uslugi"),
  area_m2 = c(203508.68181152834, 8331.793807610007, 330292.1046458139, 
              941716.2676317488, 50035.695592863165, 66272.0177607645, 
              42671.39543965236, 35433.51434325774, 4966.567884174666),
  share = c(12.09038092915902, 0.4949890101027957, 19.62254055952186, 
            55.94704020243293, 2.972603499704304, 3.937197826349665, 
            2.5350929555033397, 2.1050929240726757, 0.2950620931534011)
)

# Цвета и подписи
color_map <- c(
  "academ"   = "#f23761",
  "cultural" = "#f952e2",
  "dormit"   = "#ff807a",
  "green"    = "#abeca3",
  "indust"   = "#6863db",
  "parking"  = "#a82072",
  "sport"    = "#ffa860",
  "tech"     = "#8daf93",
  "uslugi"   = "#fff3a3"
)

labels <- c(
  "Научно-образовательная",
  "Культурно-образовательная",
  "Жилая",
  "Ландшафтно-рекреационная",
  "Зона строительства",
  "Парковочная",
  "Спортивная",
  "Коммунального хозяйства",
  "Зона услуг"
)

# Добавляем подписи и цвета
data <- data %>%
  mutate(
    Label = labels[match(FZ, names(color_map))],
    Color = color_map[FZ]
  )

# Подготовка данных для highcharter
hc_data <- data %>%
  transmute(
    name = Label,
    y = share,
    color = Color
  )

# Общая площадь в км²
total_km2 <- sum(data$area_m2) / 1e6
total_label <- sprintf("%.2f км²", total_km2)

# Интерактивная DONUT диаграмма с площадью в центре
highchart() %>%
  hc_chart(type = "pie") %>%
  hc_title(
    text = "Доли функциональных зон (%)",
    style = list(fontWeight = "bold", fontSize = "16px")
  ) %>%
  hc_plotOptions(
    pie = list(
      innerSize = "60%",       # делает donut
      allowPointSelect = TRUE,
      cursor = "pointer",
      dataLabels = list(enabled = FALSE),  # без выносок
      showInLegend = FALSE
    )
  ) %>%
  hc_tooltip(
    useHTML = TRUE,
    headerFormat = "",
    pointFormat = "<b>{point.name}</b> ({point.y:.3f}%)",  # при наведении название + процент
    backgroundColor = "rgba(255,255,255,0.95)",
    borderColor = "#ccc",
    style = list(fontSize = "13px")
  ) %>%
  hc_add_series(
    name = "Доля",
    data = list_parse(hc_data)
  ) %>%
  hc_annotations(
    list(
      labels = list(
        list(
          point = list(x = 0, y = 0, xAxis = 0, yAxis = 0),
          text = paste0("<span style='font-size:16px;font-weight:bold;'>", total_label, "</span>"),
          useHTML = TRUE,
          x = 0, y = 0
        )
      )
    )
  )
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Исходные данные"
#| padding: 0px
library(DT)

# Данные
data <- data.frame(
  FZ = c("academ", "cultural", "dormit", "green", "indust", "parking", "sport", "tech", "uslugi"),
  area_m2 = c(203508.68181152834, 8331.793807610007, 330292.1046458139, 941716.2676317488, 
              50035.695592863165, 66272.0177607645, 42671.39543965236, 35433.51434325774, 4966.567884174666),
  share = c(12.09038092915902, 0.4949890101027957, 19.62254055952186, 55.94704020243293, 
            2.972603499704304, 3.937197826349665, 2.5350929555033397, 2.1050929240726757, 0.2950620931534011)
)

# Цвета и подписи
color_map <- c(
  "academ"   = "#f23761",
  "cultural" = "#f952e2",
  "dormit"   = "#ff807a",
  "green"    = "#abeca3",
  "indust"   = "#6863db",
  "parking"  = "#a82072",
  "sport"    = "#ffa860",
  "tech"     = "#8daf93",
  "uslugi"   = "#fff3a3"
)

labels <- c(
  "Научно-образовательная",
  "Культурно-образовательная",
  "Жилая",
  "Ландшафтно-рекреационная",
  "Зона строительства",
  "Парковочная",
  "Спортивная",
  "Коммунального хозяйства",
  "Зона услуг"
)

# Добавим подписи и цвета
data$Label <- labels[match(data$FZ, names(color_map))]
data$Color <- color_map[data$FZ]

# Таблица с данными
datatable(
  data[, c("Label", "area_m2", "share")],
  colnames = c("Функциональная зона", "Площадь (м²)", "Доля (%)"),
  options = list(
    pageLength = 9,
    dom = 't',
    ordering = FALSE,
    scrollX = TRUE
  ),
  rownames = FALSE
) %>%
  formatRound(columns = c("area_m2", "share"), digits = 2)
```

# МГУ
Информация про МГУ

::: {.card}
This text will be displayed within a card
:::

# ПГНИУ
Информация про ПГНИУ
