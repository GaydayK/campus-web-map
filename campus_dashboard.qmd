---
title: "Кампусы России"
author: "[ Исследование Ксении Гайдай ]"
format: dashboard
html:
  theme: cosmo
  toc: false
  page-layout: full
---

# ДВФУ
## Column {.tabset}
```{r, out.width = '100%'}
#| echo: false
#| message: false
#| warning: false
#| title: "План кампуса"
#| padding: 0px
# Загружаем библиотеки
library(leaflet)
library(sf)
library(dplyr)
library(htmltools)
library(colorRamps)
library(RColorBrewer)

# Загружаем данные
buildings <- st_read("Buildings_poly.geojson", quiet = TRUE)
campus <- st_read("education_poly.geojson", quiet = TRUE)

# Переводим типы зданий на русский и убираем NA значения
buildings <- buildings %>%
  mutate(
    b_type_rus = recode(
      b_type,
      "academ" = "Академическое",
      "cultural" = "Культурное",
      "dormit" = "Общежитие",
      "indust" = "Индустриальное",
      "lab" = "Лабораторное",
      "parking" = "Парковка",
      "pit" = "Столовая",
      "sport" = "Спортивное",
      "tech" = "Техническое",
      .default = b_type
    )
  ) %>%
  filter(!is.na(b_type_rus) & b_type_rus != "null")  # Убираем null и NA значения

# Центр карты
center <- c(lat = 43.028842, lng = 131.893193)

# Палитра для типов зданий
b_types <- unique(buildings$b_type_rus)
n <- length(b_types)
colors <- brewer.pal(max(n, 3), "Set2") # минимум 3 цвета
palette <- colorFactor(colors, domain = b_types)

# Создаём базовую карту
map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "Стандартная основа") %>%
  addProviderTiles("Esri.WorldImagery", group = "Спутниковая основа", options = providerTileOptions(opacity = 0.5)) %>%
  setView(lng = center["lng"], lat = center["lat"], zoom = 15) %>%
  
  # Слой с границей кампуса
  addPolygons(
    data = campus,
    color = "blue",
    weight = 2,
    group = "Граница кампуса"
  ) %>%
  
  # Кнопка сброса масштаба
  addEasyButton(easyButton(
    icon = "fa-globe",
    title = "Сбросить масштаб",
    onClick = JS(
      paste0("function(btn, map){ map.setView([", center["lat"], ", ", center["lng"], "], 16); }")
    )
  ))

# Добавляем отдельный слой для каждого типа здания
for(type in b_types){
  map <- map %>%
    addPolygons(
      data = buildings %>% filter(b_type_rus == type),
      color = "black",
      weight = 1,
      fillColor = ~palette(b_type_rus),
      fillOpacity = 0.7,
      popup = ~paste("<b>Тип здания:</b>", b_type_rus),
      group = type
    )
}

# Легенда
map <- map %>%
  addLegend(
    "topright",
    pal = palette,
    values = buildings$b_type_rus,
    title = "Типы зданий",
    opacity = 0.7
  ) %>%
  
  # Объединенный контрол в левом нижнем углу
  addLayersControl(
    baseGroups = c("Стандартная основа", "Спутниковая основа"),
    overlayGroups = c(b_types, "Граница кампуса"),
    options = layersControlOptions(collapsed = FALSE, position = "bottomleft")
  )

map
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| title: "Функциональные зоны"
#| padding: 0px
# Загружаем библиотеки
library(leaflet)
library(sf)
library(dplyr)
library(htmltools)
library(RColorBrewer)

# Загружаем данные функциональных зон
func_zones <- st_read("func_zones.geojson", quiet = TRUE)

# Центр карты
center <- c(lat = 43.028842, lng = 131.893193)

# Убираем пустые или некорректные значения FZ
func_zones <- func_zones %>%
  filter(!is.na(FZ) & FZ != "null" & FZ != "")

# Создаем словарь для замены названий
fz_names <- c(
  "academ" = "Научно-образовательная",
  "cultural" = "Культурно-образовательная", 
  "dormit" = "Жилая",
  "green" = "Ландшафтно-рекреационная",
  "indust" = "Зона строительства",
  "parking" = "Парковочная",
  "sport" = "Спортивная",
  "tech" = "Коммунального хозяйства"
)

# Создаем палитру цветов
fz_colors <- c(
  "academ" = "#f23761",
  "cultural" = "#f952e2",
  "dormit" = "#ff807a", 
  "green" = "#abeca3",
  "indust" = "#6863db",
  "parking" = "#a82072",
  "sport" = "#ffa860",
  "tech" = "#8daf93"
)

# Добавляем новые названия и цвета в данные
func_zones <- func_zones %>%
  mutate(
    FZ_name = fz_names[FZ],
    FZ_color = fz_colors[FZ]
  )

# Получаем список уникальных функциональных зон (уже с новыми названиями)
fz_types <- unique(func_zones$FZ_name)
n <- length(fz_types)

# Создаем палитру для leaflet
palette <- colorFactor(
  palette = fz_colors,
  domain = func_zones$FZ,
  na.color = "transparent"
)

# Создаём базовую карту
map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "Стандартная основа") %>%
  addProviderTiles("Esri.WorldImagery", group = "Спутниковая основа", 
                   options = providerTileOptions(opacity = 0.5)) %>%
  setView(lng = center["lng"], lat = center["lat"], zoom = 15) %>%
  
  # Кнопка сброса масштаба
  addEasyButton(easyButton(
    icon = "fa-globe",
    title = "Сбросить масштаб",
    onClick = JS(
      paste0("function(btn, map){ map.setView([", center["lat"], ", ", center["lng"], "], 16); }")
    )
  ))

# Добавляем слой для каждой функциональной зоны
for (fz in unique(func_zones$FZ)) {
  fz_data <- func_zones %>% filter(FZ == fz)
  fz_display_name <- fz_names[fz]
  
  map <- map %>%
    addPolygons(
      data = fz_data,
      color = "black",
      weight = 1,
      fillColor = ~palette(FZ),
      fillOpacity = 0.7,
      popup = ~paste("<b>Функциональная зона:</b>", FZ_name),
      group = fz_display_name
    )
}

# Создаем легенду с новыми названиями и цветами
legend_colors <- fz_colors
legend_labels <- fz_names

# Добавляем легенду и контролы
map <- map %>%
  addLegend(
    "topright",
    colors = legend_colors,
    labels = legend_labels,
    title = "Функциональные зоны",
    opacity = 0.7
  ) %>%
  
  addLayersControl(
    baseGroups = c("Стандартная основа", "Спутниковая основа"),
    options = layersControlOptions(collapsed = FALSE, position = "bottomleft")
  )

map
```

# МГУ
